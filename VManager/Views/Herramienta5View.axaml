<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="VManager.Views.Herramienta5View"
             x:DataType="vm:Herramienta5ViewModel"
             xmlns:vm="using:VManager.ViewModels"
             xmlns:models="using:VManager.Models"
             xmlns:services="clr-namespace:VManager.Services"
             x:Name="Root">

  <UserControl.Resources>
    <services:ValidPathConverter x:Key="ValidPathConverter" />
  </UserControl.Resources>
  
  <UserControl.Styles>
    <Style Selector="ListBoxItem">
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Margin" Value="0"/>
      <Setter Property="MinHeight" Value="0"/>
    </Style>
  </UserControl.Styles>
  
  <Grid ClipToBounds="True">
    <Border BorderBrush="{DynamicResource BorderBrushPrimary}" 
            BorderThickness="2" 
            CornerRadius="10" 
            Padding="0" 
            Margin="0,10,20,0"
            Background="{DynamicResource PanelBackgroundBrush}"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            ClipToBounds="True">

      <ScrollViewer Padding="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" AllowAutoHide="True" Background="Transparent">
      
        <StackPanel Margin="20" Spacing="12" HorizontalAlignment="Center" VerticalAlignment="Center">

          <!-- TÃ­tulo -->
          <TextBlock Text="{Binding L[VDownload.Title]}" 
                     FontSize="25" 
                     HorizontalAlignment="Center" 
                     FontWeight="Bold"/>
          
          <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0,0,0,20">
            <Button Command="{Binding ClearInfoCommand}"
                    x:Name="ClearInfo"
                    HotKey="F5"
                    HorizontalAlignment="Center"
                    Width="105">
              <Button.Content>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                  <PathIcon Data="M5.50999526,3.31842271 C5.12151573,3.31842271 4.80046129,3.60710385 4.74965,3.9816481 L4.74264499,4.08577298 L4.74264499,6.97963208 C4.74264499,7.36811161 5.03132614,7.68916605 5.40587038,7.73997735 L5.50999526,7.74698235 L8.40385436,7.74698235 C8.82765021,7.74698235 9.17120463,7.40342793 9.17120463,6.97963208 C9.17120463,6.59115255 8.88252349,6.27009811 8.50797925,6.21928681 L8.40385436,6.21228181 L7.42512053,6.21182461 C10.3377833,3.87107476 14.6073963,4.05209336 17.3101833,6.75488039 C20.2069829,9.65167996 20.2069829,14.34832 17.3101833,17.2451196 C14.4133838,20.1419192 9.71674369,20.1419192 6.81994412,17.2451196 C5.05698183,15.4821573 4.31886614,12.9925923 4.78189684,10.58925 C4.86207142,10.173107 4.58971523,9.77076216 4.17357228,9.69058758 C3.75742932,9.610413 3.35508446,9.88276918 3.27490988,10.2989121 C2.71652434,13.1971899 3.60781134,16.2033812 5.73474696,18.3303168 C9.23088437,21.8264542 14.8992431,21.8264542 18.3953805,18.3303168 C21.8915179,14.8341794 21.8915179,9.16582064 18.3953805,5.66968323 C15.0747703,2.34907304 9.7945807,2.18235834 6.27720505,5.16953912 L6.27734554,4.08577298 C6.27734554,3.66197713 5.93379112,3.31842271 5.50999526,3.31842271 Z" 
                            Width="15" Height="15" />
                  <TextBlock Text="{Binding L[VDownload.Buttons.Refresh]}" VerticalAlignment="Center"/>
                </StackPanel>
              </Button.Content>
            </Button>
          </StackPanel>

          <!-- Entrada de URL -->
          <StackPanel Spacing="8" HorizontalAlignment="Stretch" MaxWidth="600">

          <!-- TÃ­tulo con icono -->
          <StackPanel Orientation="Horizontal"
                      HorizontalAlignment="Center"
                      Spacing="6">
              <PathIcon Width="18"
                        Height="18"
                        Data="M15.9862 3.99944C15.8616 2.87472 14.9079 2 13.75 2H10.25C9.09205 2 8.13841 2.87472 8.01379 3.99944L6.25 4C5.00736 4 4 5.00736 4 6.25V19.75C4 20.9926 5.00736 22 6.25 22H10.9996C10.6634 21.5523 10.4005 21.0464 10.2289 20.5H6.25C5.83579 20.5 5.5 20.1642 5.5 19.75V6.25C5.5 5.83579 5.83579 5.5 6.25 5.5L8.37902 5.5002C8.78267 6.1031 9.46997 6.5 10.25 6.5H13.75C14.5284 6.5 15.2145 6.10471 15.6185 5.50391H17.5023V5.50002L17.75 5.5C18.1642 5.5 18.5 5.83579 18.5 6.25V14H20V6.25C20 5.00736 18.9926 4 17.75 4L15.9862 3.99944ZM10.25 3.5H13.75C14.1642 3.5 14.5 3.83579 14.5 4.25C14.5 4.66421 14.1642 5 13.75 5H10.25C9.83579 5 9.5 4.66421 9.5 4.25C9.5 3.83579 9.83579 3.5 10.25 3.5Z M19 15C21.2091 15 23 16.7909 23 19C23 21.1422 21.316 22.8911 19.1996 22.9951L19 23C18.5858 23 18.25 22.6642 18.25 22.25C18.25 21.8703 18.5322 21.5565 18.8982 21.5068L19 21.5C20.3807 21.5 21.5 20.3807 21.5 19C21.5 17.6745 20.4685 16.59 19.1644 16.5053L19 16.5C18.5858 16.5 18.25 16.1642 18.25 15.75C18.25 15.3703 18.5322 15.0565 18.8982 15.0068L19 15Z M15 15C15.4142 15 15.75 15.3358 15.75 15.75C15.75 16.1297 15.4678 16.4435 15.1018 16.4932L15 16.5C13.6193 16.5 12.5 17.6193 12.5 19C12.5 20.3255 13.5315 21.41 14.8356 21.4947L15 21.5C15.4142 21.5 15.75 21.8358 15.75 22.25C15.75 22.6297 15.4678 22.9435 15.1018 22.9932L15 23C12.7909 23 11 21.2091 11 19C11 16.8578 12.684 15.1089 14.8004 15.0049L15 15Z M15.25 18.25H18.75C19.1642 18.25 19.5 18.5858 19.5 19C19.5 19.3797 19.2178 19.6935 18.8518 19.7432L18.75 19.75H15.25C14.8358 19.75 14.5 19.4142 14.5 19C14.5 18.6203 14.7822 18.3065 15.1482 18.2568L15.25 18.25Z"/>

              <TextBlock Text="Pegar URL de video"
                         FontSize="14"
                         FontWeight="SemiBold"/>
          </StackPanel>


          <Grid ColumnDefinitions="*,Auto">
              <TextBox Grid.Column="0"
                       x:Name="UrlEntry"
                       Watermark="https://www.youtube.com/watch?v=..."
                       Text="{Binding UrlText, Mode=TwoWay}"
                       HorizontalAlignment="Stretch"/>

              <Button Grid.Column="1"
                      Content="âž• Agregar"
                      Command="{Binding AddUrlCommand}"
                      CommandParameter="{Binding UrlText}"
                      Width="100"/>
          </Grid>

          <!-- Contador -->
          <TextBlock Text="{Binding VideoCount, StringFormat='Videos en cola: {0}'}"
                     FontSize="12"
                     Opacity="0.8"
                     HorizontalAlignment="Center"
                     Margin="0,4,0,0"/>
      </StackPanel>


          <!-- Lista de Videos -->
          <Border BorderBrush="{DynamicResource BorderBrushPrimary}"
                  BorderThickness="1"
                  CornerRadius="8"
                  Margin="0,10,0,0"
                  MinHeight="50"
                  MaxHeight="400"
                  MaxWidth="700">

            <ListBox ItemsSource="{Binding Videos}"
                     x:Name="VideoListBox"
                     Background="Transparent"
                     BorderThickness="0"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled">

              <ListBox.ItemTemplate>
                <DataTemplate DataType="models:VideoDownloadItem">
                  <Border Padding="10"
                          CornerRadius="6"
                          BorderBrush="#333"
                          BorderThickness="1"
                          Margin="4"
                          MaxWidth="600">

                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="80,*,Auto">
                      
                      <!-- Thumbnail -->
                      <Border Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                              Width="70" Height="50"
                              CornerRadius="4"
                              ClipToBounds="True"
                              Background="#222"
                              Margin="0,0,10,0">
  
                        <Panel>
                          <!-- Thumbnail Image -->
                          <Image Source="{Binding ThumbnailBitmap}"
                                 Stretch="UniformToFill"
                                 IsVisible="{Binding ThumbnailBitmap, Converter={x:Static ObjectConverters.IsNotNull}}"/>
    
                          <!-- Loading Indicator -->
                          <TextBlock Text="â³"
                                     FontSize="20"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"
                                     IsVisible="{Binding IsLoading}"/>
    
                          <!-- Error Indicator -->
                          <TextBlock Text="âŒ"
                                     FontSize="20"
                                     HorizontalAlignment="Center"
                                     VerticalAlignment="Center"
                                     IsVisible="{Binding HasError}"/>
                        </Panel>
  
                      </Border>

                      <!-- TÃ­tulo y detalles -->
                      <StackPanel Grid.Row="0" Grid.Column="1" Spacing="4">
                        <TextBlock Text="{Binding Title}"
                                   FontWeight="SemiBold"
                                   FontSize="13"
                                   TextTrimming="CharacterEllipsis"
                                   MaxLines="1"
                                   ToolTip.Tip="{Binding Title}"/>
                        
                        <StackPanel Orientation="Horizontal" Spacing="10" Opacity="0.7">
                          <TextBlock Text="{Binding Duration, StringFormat='â±ï¸ {0}'}"
                                     FontSize="11"
                                     IsVisible="{Binding Duration, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>
                          <TextBlock Text="{Binding FileSizeFormatted, StringFormat='ðŸ’¾ {0}'}"
                                     FontSize="11"
                                     IsVisible="{Binding FileSize, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                        </StackPanel>
                      </StackPanel>

                      <!-- Selector de calidad -->
                      <ComboBox Grid.Row="1" Grid.Column="1"
                                ItemsSource="{Binding AvailableFormats}"
                                SelectedItem="{Binding SelectedFormat}"
                                Margin="0,4,0,0"
                                HorizontalAlignment="Left"
                                IsVisible="{Binding !IsLoading}">
                        <ComboBox.ItemTemplate>
                          <DataTemplate DataType="models:VideoFormat">
                            <TextBlock Text="{Binding DisplayName}"/>
                          </DataTemplate>
                        </ComboBox.ItemTemplate>
                      </ComboBox>

                      <!-- Barra de progreso individual -->
                      <ProgressBar Grid.Row="2" Grid.Column="1"
                                   Value="{Binding Progress}"
                                   Height="4"
                                   Margin="0,6,0,0"
                                   IsVisible="{Binding IsDownloading}"
                                   Foreground="{DynamicResource AccentBrush}"/>
                      
                      <!-- Estado -->
                      <TextBlock Grid.Row="2" Grid.Column="1"
                                 Text="{Binding Status}"
                                 FontSize="10"
                                 Opacity="0.7"
                                 Margin="0,6,0,0"
                                 IsVisible="{Binding Status, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"/>

                      <!-- BotÃ³n eliminar -->
                      <Button Grid.Row="0" Grid.RowSpan="2" Grid.Column="2"
                              Width="32"
                              Height="32"
                              Padding="0"
                              Content="âœ•"
                              FontSize="16"
                              VerticalAlignment="Center"
                              VerticalContentAlignment="Center"
                              HorizontalContentAlignment="Center"
                              Background="#b22b2b"
                              Foreground="White"
                              BorderThickness="0"
                              CornerRadius="4"
                              Command="{Binding #Root.((vm:Herramienta5ViewModel)DataContext).RemoveUrlCommand}"
                              CommandParameter="{Binding}"
                              IsEnabled="{Binding !IsDownloading}">
                        <Button.Styles>
                          <Style Selector="Button:pointerover /template/ Border">
                            <Setter Property="Background" Value="#d43b3b"/>
                          </Style>
                        </Button.Styles>
                      </Button>

                    </Grid>

                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>

            </ListBox>
          </Border>

          <!-- Barra de progreso global -->
          <Grid Margin="0,15,0,0" HorizontalAlignment="Stretch" MaxWidth="600">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <TextBlock Grid.Row="0" 
                       FontSize="10" 
                       IsVisible="{Binding ShouldShowRemainingTime}" 
                       Text="{Binding RemainingTime, StringFormat='â±ï¸ Tiempo restante: {0}'}"
                       HorizontalAlignment="Center" 
                       Margin="0,0,0,4"/>
            
            <ProgressBar Grid.Row="1" 
                         Minimum="0" 
                         Maximum="100" 
                         ShowProgressText="True"
                         Value="{Binding Progress}" 
                         Height="22"/>
          </Grid>

          <!-- Estado global -->
          <TextBlock Text="{Binding Status}" 
                     FontSize="12" 
                     Margin="0,4,0,0" 
                     HorizontalAlignment="Center"
                     FontWeight="SemiBold"/>
          
          <!-- Botones de acciÃ³n -->
          <StackPanel Orientation="Vertical" Spacing="8" Margin="0,10,0,0">
            <Button Content="{Binding L[VDownload.Buttons.Download]}" 
                    HorizontalContentAlignment="Center"
                    FontSize="18" 
                    Classes="Accented"
                    FontWeight="DemiBold"
                    IsEnabled="{Binding IsVideoPathSet}"
                    Command="{Binding DownloadCommand}" 
                    HotKey="Enter"
                    Width="200" 
                    HorizontalAlignment="Center"/>
            
            <Button Content="{Binding L[VDownload.Buttons.Cancel]}"
                    HorizontalContentAlignment="Center"
                    IsEnabled="{Binding IsConverting}"
                    FontSize="12"
                    Command="{Binding ShowCancelDialogCommand}"
                    Classes="RedAccented"
                    HotKey="Escape"
                    HorizontalAlignment="Center"
                    Width="100"/>
          </StackPanel>

          <!-- Mostrar archivo -->
          <ToggleButton Content="Mostrar en carpeta"
                        HorizontalContentAlignment="Center"
                        IsVisible="{Binding IsFileReadyVisible}"
                        IsChecked="{Binding IsClicked, Mode=TwoWay}"
                        Command="{Binding ShowFileInFolderCommand}"
                        HorizontalAlignment="Center"
                        Margin="0,15,0,0">
            <ToggleButton.Styles>
              <Style Selector="ToggleButton:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentForegroundBrush}" />
              </Style>
              <Style Selector="ToggleButton:pressed /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentForegroundBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentBrush}" />
              </Style>
              <Style Selector="ToggleButton:checked /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentForegroundBrush}" />
              </Style>
            </ToggleButton.Styles>
          </ToggleButton>

        </StackPanel>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>