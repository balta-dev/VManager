<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="VManager.Views.Herramienta5View"
             x:DataType="vm:Herramienta5ViewModel"
             xmlns:vm="using:VManager.ViewModels"
             xmlns:services="clr-namespace:VManager.Services"
             x:Name="Root">

  <UserControl.Resources>
    <services:ValidPathConverter x:Key="ValidPathConverter" />
  </UserControl.Resources>
  
  <UserControl.Styles>
    <Style Selector="ListBoxItem">
      <Setter Property="Padding" Value="0"/>
      <Setter Property="Margin" Value="0"/>
      <Setter Property="MinHeight" Value="0"/>
    </Style>
  </UserControl.Styles>
  
  <Grid ClipToBounds="True">
    <Border BorderBrush="{DynamicResource BorderBrushPrimary}" 
            BorderThickness="2" 
            CornerRadius="10" 
            Padding="0" 
            Margin="0,10,20,0"
            Background="{DynamicResource PanelBackgroundBrush}"
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            ClipToBounds="True">

      <ScrollViewer Padding="0" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled" AllowAutoHide="True" Background="Transparent">
      
        <StackPanel Margin="20" Spacing="12" HorizontalAlignment="Center" VerticalAlignment="Center">

          <!-- Título -->
          <TextBlock Text="{Binding L[VDownload.Title]}" 
                     FontSize="25" 
                     HorizontalAlignment="Center" 
                     FontWeight="Bold"/>
          
          <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center" Margin="0,0,0,35">
            <Button Command="{Binding ClearInfoCommand}"
                    x:Name="ClearInfo"
                    HotKey="F5"
                    HorizontalAlignment="Center"
                    Width="105">
              <Button.Content>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                  <PathIcon Data="M5.50999526,3.31842271 C5.12151573,3.31842271 4.80046129,3.60710385 4.74965,3.9816481 L4.74264499,4.08577298 L4.74264499,6.97963208 C4.74264499,7.36811161 5.03132614,7.68916605 5.40587038,7.73997735 L5.50999526,7.74698235 L8.40385436,7.74698235 C8.82765021,7.74698235 9.17120463,7.40342793 9.17120463,6.97963208 C9.17120463,6.59115255 8.88252349,6.27009811 8.50797925,6.21928681 L8.40385436,6.21228181 L7.42512053,6.21182461 C10.3377833,3.87107476 14.6073963,4.05209336 17.3101833,6.75488039 C20.2069829,9.65167996 20.2069829,14.34832 17.3101833,17.2451196 C14.4133838,20.1419192 9.71674369,20.1419192 6.81994412,17.2451196 C5.05698183,15.4821573 4.31886614,12.9925923 4.78189684,10.58925 C4.86207142,10.173107 4.58971523,9.77076216 4.17357228,9.69058758 C3.75742932,9.610413 3.35508446,9.88276918 3.27490988,10.2989121 C2.71652434,13.1971899 3.60781134,16.2033812 5.73474696,18.3303168 C9.23088437,21.8264542 14.8992431,21.8264542 18.3953805,18.3303168 C21.8915179,14.8341794 21.8915179,9.16582064 18.3953805,5.66968323 C15.0747703,2.34907304 9.7945807,2.18235834 6.27720505,5.16953912 L6.27734554,4.08577298 C6.27734554,3.66197713 5.93379112,3.31842271 5.50999526,3.31842271 Z" 
                            Width="15" Height="15" />
                  <TextBlock Text="{Binding L[VDownload.Buttons.Refresh]}" VerticalAlignment="Center"/>
                </StackPanel>
              </Button.Content>
            </Button>
          </StackPanel>

          <!-- Selección de URL -->
          <StackPanel Spacing="6" HorizontalAlignment="Stretch">
            <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
              <TextBlock Text="{Binding L[VDownload.Fields.PasteVideo]}"
                         FontSize="14"
                         VerticalAlignment="Center"/>
            </StackPanel>

            <!-- Textbox para ingresar URL -->
            <Border Padding="2">
              <TextBox x:Name="UrlEntry"
                       Watermark="Pegá la URL aquí..."
                       Text="{Binding UrlText, Mode=TwoWay}"
                       HorizontalAlignment="Stretch"/>
            </Border>

            <!-- Botón Agregar URL -->
            <Button Content="Agregar URL"
                    Command="{Binding AddUrlCommand}"
                    CommandParameter="{Binding #UrlEntry.Text}"
                    Width="150"
                    HorizontalAlignment="Center"/>

            <!-- Contador de videos -->
            <TextBlock Text="{Binding VideoCount, StringFormat='Videos cargados: {0}'}"
                       FontSize="13"
                       HorizontalAlignment="Center"
                       Margin="0,5,0,0"/>
            
            <!-- Lista de URLs agregadas -->
            <Border BorderBrush="{DynamicResource BorderBrushPrimary}"
                    BorderThickness="1"
                    CornerRadius="5"
                    Margin="0,10,0,0"
                    MinHeight="60"
                    MaxHeight="120">

              <ListBox ItemsSource="{Binding VideoPaths}"
                       x:Name="UrlListBox"
                       Background="Transparent"
                       BorderThickness="0"
                       Padding="0"
                       HorizontalAlignment="Stretch">

                <ListBox.ItemTemplate>
                  <DataTemplate>
                    <!--
                      Controlamos el espaciado y apariencia directamente en el template.
                      El Margin del Border hace la separación entre ítems (menos "espacio muerto").
                    -->
                    <Border 
                            Padding="6"
                            CornerRadius="6"
                            BorderBrush="#333"
                            BorderThickness="1"
                            Margin="6 4"> 
                      
                      <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
                        
                        <!-- URL -->
                        <TextBlock Grid.Column="0" 
                                   Text="{Binding}" 
                                   VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis"
                                   Margin="0,0,10,0"
                                   MaxLines="1"/>

                        <!-- Botón eliminar -->
                        <Button Grid.Column="1"
                                Width="28"
                                Height="28"
                                Padding="0"
                                Content="✕"
                                FontSize="14"
                                VerticalContentAlignment="Center"
                                HorizontalContentAlignment="Center"
                                Background="#b22b2b"
                                Foreground="White"
                                BorderThickness="0"
                                Command="{Binding #Root.((vm:Herramienta5ViewModel)DataContext).RemoveUrlCommand}"
                                CommandParameter="{Binding}">
                          <Button.Styles>
                            <Style Selector="Button:pointerover /template/ Border">
                              <Setter Property="Background" Value="#d43b3b"/>
                            </Style>
                          </Button.Styles>
                        </Button>

                      </Grid>

                    </Border>
                  </DataTemplate>
                </ListBox.ItemTemplate>

              </ListBox>
            </Border>

          </StackPanel>

          <!-- Barra de progreso + porcentaje -->
          <Grid Margin="0,20,0,0" HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            
            <!-- Tiempo restante -->
            <TextBlock Grid.Row="0" 
                       FontSize="10" 
                       IsVisible="{Binding ShouldShowRemainingTime}" 
                       Text="{Binding RemainingTime, StringFormat='Tiempo estimado restante: {0}'}"
                       HorizontalAlignment="Center" 
                       Margin="0,0,0,4"/>
            
            <!-- Barra de progreso -->
            <ProgressBar Grid.Row="1" 
                         Minimum="0" 
                         Maximum="100" 
                         ShowProgressText="True"
                         Value="{Binding Progress}" 
                         Height="20"/>
          </Grid>

          <!-- Estado -->
          <TextBlock Text="{Binding Status}" 
                     FontSize="12" 
                     Margin="0,3,0,0" 
                     HorizontalAlignment="Center"/>
          <TextBlock Text="{Binding OutputPath}" 
                     FontSize="12" 
                     Margin="0,-4,0,0" 
                     HorizontalAlignment="Center"/>
          <TextBlock Text="{Binding Warning}" 
                     FontSize="12" 
                     Margin="0,-6,0,0" 
                     HorizontalAlignment="Center"/>
          
          <!-- Botón descargar -->
          <Button Content="{Binding L[VDownload.Buttons.Download]}" 
                  HorizontalContentAlignment="Center"
                  FontSize="18" 
                  Classes="Accented"
                  FontWeight="DemiBold"
                  IsEnabled="{Binding IsVideoPathSet}"
                  Command="{Binding DownloadCommand}" 
                  HotKey="Enter"
                  Width="180" 
                  Margin="0,0,0,0" 
                  HorizontalAlignment="Center"/>
          
          <Button Content="{Binding L[VDownload.Buttons.Cancel]}"
                  HorizontalContentAlignment="Center"
                  IsEnabled="{Binding IsConverting}"
                  FontSize="12"
                  Margin="0,-7,0,0"
                  Command="{Binding ShowCancelDialogCommand}"
                  Classes="RedAccented"
                  HotKey="Escape"
                  HorizontalAlignment="Center"
                  Width="90"/>

          <!-- Mostrar archivo en carpeta -->
          <ToggleButton Content="Mostrar archivo en carpeta"
                        HorizontalContentAlignment="Center"
                        IsVisible="{Binding IsFileReadyVisible}"
                        IsChecked="{Binding IsClicked, Mode=TwoWay}"
                        Command="{Binding ShowFileInFolderCommand}"
                        HorizontalAlignment="Center"
                        Margin="0,20,0,0">
            <ToggleButton.Styles>
              <!-- Hover -->
              <Style Selector="ToggleButton:pointerover /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentForegroundBrush}" />
              </Style>

              <!-- Pressed -->
              <Style Selector="ToggleButton:pressed /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentForegroundBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentBrush}" />
              </Style>

              <!-- Checked -->
              <Style Selector="ToggleButton:checked /template/ ContentPresenter#PART_ContentPresenter">
                <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                <Setter Property="Foreground" Value="{DynamicResource AccentForegroundBrush}" />
              </Style>
            </ToggleButton.Styles>
          </ToggleButton>

        </StackPanel>
      </ScrollViewer>
    </Border>
  </Grid>
</UserControl>